@page
@model HarelTech.WMS.App.Pages.Tasks.TransactionModel
@{
    ViewData["Title"] = "Transaction";
    var i = 0;
    var curType = (long)Model.CurrentTaskType;
}

@Html.AntiForgeryToken()

<input type="hidden" id="task_type" value="@curType" />
<input type="hidden" id="priority_ready" value="false" />
<input type="hidden" id="total_tasks" value="@Model.TaskItem.TotalTasks" />
<input type="hidden" id="jsonTasks" value="@Model.TaskLotJson" />
<div class="animated flipInY fast" style="margin-top:20px;">
    <div class="accordion md-accordion m-3" id="accordionEx1" role="tablist" aria-multiselectable="false">
        <!-- Accordion card -->
        <div class="card">
            <!-- Card header -->
            <div class="card-header" role="tab" id="headingTwo1">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordionEx1" href="#collapseTwo1"
                   aria-expanded="false" aria-controls="collapseTwo1" style="color: black !important;">
                    <h5 class="mb-0">
                        @Model.TaskItem.PARTDES <span class="float-right" style="color: #3DBFD9 !important;"><span id="complete_tasks">@Model.TaskItem.CompletedTasks</span>/@Model.TaskItem.TotalTasks</span>
                    </h5>
                </a>
            </div>

            <!-- Card body -->
            <div id="collapseTwo1" class="collapse" role="tabpanel" aria-labelledby="headingTwo1"
                 data-parent="#accordionEx1">
                <div class="card-body">
                    <div class="row mt-2" style="font-weight: 600 !important">
                        <div class="col-6">Task:</div>
                        <div class="col-6">@Model.TaskItem.HWMS_ITASKTYPE</div>
                    </div>
                    <div class="row mt-2" style="font-weight: 600 !important">
                        <div class="col-6">Order/Doc:</div>
                        <div class="col-6">@Model.TaskItem.HWMS_REFORDER</div>
                    </div>
                    <div class="row mt-2" style="font-weight: 600 !important">
                        <div class="col-6">Task #:</div>
                        <div class="col-6">@Model.TaskItem.HWMS_ITASKNUM</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- Search-->
    <form class="form-inline d-flex justify-content-center md-form form-sm active-cyan-2 mt-4">
        <input id="search_group" class="form-control form-control-sm mr-2 w-75" type="text" placeholder="Scan Lot"
               aria-label="Search Bin" onkeyup="search_on_list();" autofocus>
        <i class="fas fa-search" aria-hidden="true"></i>
    </form>
</div>
<div id="task_lots" class="animated fadeInY">
    @foreach (var item in Model.TaskLot)
    {
        <input type="hidden" id="lot_id"/>
        <div id="card_@i" class="card m-2" data-lotnumber="@item.HWMS_ELOTNUMBER" data-lot="@item.HWMS_LOT" data-taskid="@Model.TaskItem.HWMS_ITASK">
            <div class="card-body m-2">
                <div class="row" style="font-weight: 700 !important">
                    <div class="col-6">Lot #:</div>
                    <div class="col-6" style="color: #3DBFD9;">@item.HWMS_ELOTNUMBER</div>
                </div>
                <div class="row mt-1" style="font-size: 12px !important;">
                    <div class="col-6">Status:</div>
                    <div class="col-6" id="status_@i">@item.STATUS</div>
                </div>
                <div class="row mt-1" style="font-size: 12px !important;">
                    <div class="col-6">Exp:</div>
                    <div class="col-6" id="exp_date_@i">@item.ExpDate</div>
                </div>
                <hr />

                <div class="row mt-2" style="font-weight: 600 !important">
                    <div class="col-6">Available:</div>
                    <div class="col-6">@item.AVAILABLE @item.UNITNAME</div>
                </div>
                <div class="row mt-4" style="font-weight: 600 !important;background-color: #E9F5FF;">
                    <div class="col-6">From Bin/Area:</div>
                    <div class="col-6" id="frombin_@i">@item.FROMBIN</div>
                </div>
                <div class="row" style="font-weight: 600 !important;background-color: #E9F5FF;">
                    <div class="col-6">To Bin/Area:</div>
                    <div class="col-6" id="tobin_@i">@Model.TaskItem.HWMS_ITASKTOBIN</div>
                </div>
                <div class="row text-center mt-4">
                    <div class="col-4" style="font-weight: 600 !important;">Quantity:</div>
                    <div class="col-8">
                        <div class="def-number-input number-input safari_only" style="background-color:#3DBFD9;">
                            <button onclick="minusQty('qty_@i');" class="minus"></button>
                            <input id="qty_@i" class="quantity" min="0" max="@item.AVAILABLE" name="quantity" value="0" type="number" onchange="update_total_tasks();" required>
                            <button onclick="plusQty('qty_@i');" class="plus"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        i++;
    }

</div>
<nav class="navbar fixed-bottom navbar-expand-lg text-center" style="background-color: #3DBFD9 !important">
    @*<button id="btn_login" class="btn btn-primary btn-block my-4 waves-effect" style="background-color:#3DBFD9 !important;color: white;">
            Post Transaction
            <i class="fas fa-arrow-right float-right"></i>
        </button>*@
    <p id="btn_complete_task" class="w-100 disabled btn-dark mt-2 text-white" onclick="complete_task();">Post Transaction <i class="fas fa-arrow-right mt-2" style="color:white !important"></i></p>
</nav>
<!--Modal: modalConfirmPartialCompleteTask-->
<div class="modal fade" id="modalConfirmPartialCompleteTask" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-sm modal-notify modal-danger modal-dialog-centered" role="document">
        <!--Content-->
        <div class="modal-content text-center">
            <!--Header-->
            <div class="modal-header d-flex justify-content-center">
                <p class="heading">Are you sure?</p>
            </div>

            <!--Body-->
            <div class="modal-body">
                <p id="p_message">Task will be completed and closed with missing quantitys:</p>
                <p>Total Tasks: @Model.TaskItem.TotalTasks</p>
                <p>Total Reported: <span id="total_reported"></span></p>
            </div>

            <!--Footer-->
            <div class="modal-footer flex-center">
                <a href="" class="btn  btn-outline-danger">Yes</a>
                <a type="button" class="btn  btn-danger waves-effect" data-dismiss="modal">No</a>
            </div>
        </div>
        <!--/.Content-->
    </div>
</div>
<!--Modal: modalConfirmDelete-->
<!--Modal: modalConfirmCompleteTask-->
<div class="modal fade" id="modalConfirmCompleteTask" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-sm modal-notify modal-info modal-dialog-centered" role="document">
        <!--Content-->
        <div class="modal-content text-center">
            <!--Header-->
            <div class="modal-header d-flex justify-content-center">
                <p class="heading">Are you sure?</p>
            </div>

            <!--Body-->
            <div class="modal-body">
                <p id="p_message">Task will be completed and closed</p>
            </div>

            <!--Footer-->
            <div class="modal-footer flex-center">
                <a href="#" onclick="finalize_task();" class="btn  btn-outline-info waves-effect">Yes</a>
                <a type="button" class="btn  btn-danger waves-effect" data-dismiss="modal">No</a>
            </div>
        </div>
        <!--/.Content-->
    </div>
</div>
<!--Modal: modalConfirmDelete-->


<script>
    var tasksForm;
    var config;
    var filter;
    var totalQty = 0;

    $(document).ready(function () {

        $("#btn_back").attr("href", "/Tasks/TaskItems?taskType=@curType&refOrderZone=@Model.TaskItem.RefOrderOrZone");
        //$("#btn_back").attr("asp-taskType", @curType);
        //$("#btn_back").attr("asp-refOrderZone", '@Model.TaskItem.RefOrderOrZone');
        $("#btn_back").show();
            //get_group_Tasks(1);

        @*$("#btn_back").on("click", function () {
            $("#btn_back").attr("href", "/Tasks/TaskItems");
            $("#btn_back").attr("asp-taskType", @Model.CurrentTaskType);
            $("#btn_back").attr("asp-refOrderZone", @Model.TaskItem.RefOrderOrZone);
            parent.history.back();
            return false;
        })*@


        config = {username: '@Model.UserName', password: '@Model.Password',
        url: app.priorityUrl,
        language: 3,
        appname: 'wmsapp'};

        filter = {
        or: 0,
        ignorecase: 0,
        QueryValues:
            [
                {
                field: "HWMS_ITASKNUM",
                fromval: "@Model.TaskItem.HWMS_ITASKNUM",
                }
            ]
        };


    });

    function showMessage(message) {
        //if (message.type != "warning") {
        //    alert(message.message);
        //} else {
        if (confirm(message.message)) {
            message.form.warningConfirm(1);
        } else {
            message.form.warningConfirm(0);
        }
        //}
    }

    function updateFields() {

    }

    function search_on_list() {
        var input = document.getElementById("search_group");
        var filter = input.value.toLowerCase();
        var nodes = $("#task_lots .card");

        for (i = 0; i < nodes.length; i++) {
            if (!filter || filter === '') {
                nodes[i].style.display = "block";
                continue;
            }
            if (nodes[i].innerText.toLowerCase().includes(filter)) {
                nodes[i].style.display = "block";
            } else {
                nodes[i].style.display = "none";
            }
        }
    }

    function plusQty(elm) {
        document.getElementById(elm).stepUp(1);
        update_total_tasks();
    }

    function minusQty(elm) {
        document.getElementById(elm).stepDown(1);
        update_total_tasks();
    }

    function update_total_tasks() {
        var cards = $("#task_lots .card");
        var tot = 0;
        for (var i = 0; i < cards.length; i++) {
            var inpInt = parseInt($("#qty_" + i).val());
            tot += inpInt;
        }
        $("#complete_tasks").html(tot).fadeIn(500);
        if (tot > 0)
            $("#btn_complete_task").removeClass("btn-dark disabled");
        else
            $("#btn_complete_task").addClass("btn-dark disabled");

        totalQty = tot;
        return tot;
    }

    function complete_task() {
        var totalCount = update_total_tasks();
        var totalTasks = parseInt($("#total_tasks").val());
        $("#total_reported").html(totalCount);
        if (totalCount > totalTasks) {
            $("#modalConfirmCompleteTask #p_message").html(`Quantity reported is higher than ${totalTasks} ins!`);
            $("#modalConfirmCompleteTask").modal("show");
        }
        else if (totalCount === totalTasks)
        {
            $("#modalConfirmCompleteTask #p_message").html("Please Confirm");
            $("#modalConfirmCompleteTask").modal("show");
        }
        else {
            
            $("#modalConfirmPartialCompleteTask #p_message").html(`Quantity reported is lower than ${totalTasks} ins!`);
            $("#modalConfirmPartialCompleteTask").modal("show");
        }
    }

    function finalize_task() {
        $("#modalConfirmCompleteTask").modal('hide')
        app.showLoader();

        var tasks = JSON.parse($("#jsonTasks").val());
        var taskLots = [];

        for (var i = 0; i < tasks.length; i++) {
            var qty = parseInt($("#qty_" + i).val());
            if (qty === 0)
                continue;

            taskLots.push({
                "HWMS_ELOTNUMBER": $("#card_" + i).data("lotnumber"),
                "Quantity": qty,
                "FROMBIN": $("#frombin_" + i).html(),
                "TOBIN": $("#tobin_" + i).html(),
                "ExpDate": $("#exp_date_" + i).html(),
                "HWMS_LOT": $("#card_" + i).data("lot"),
                "HWMS_ITASK": $("#card_" + i).data("taskid"),
                "STATUS": '',
                "EXPIRYDATE": 0,
                "AVAILABLE": 0,
                "UNITNAME": '',
                "HWMS_FCUSTNAME": $("#status_" + i).html(),
                "HWMS_TCUSTNAME": $("#status_" + i).html()
            });

        }

        //call add task
        debugger;
        $.ajax({
            type: "POST",
            url: "/Tasks/Transaction/?handler=AddTaskLots",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("RequestVerificationToken",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            data:  JSON.stringify(taskLots) ,
            success: function (response) {
                if (response.success);
                window.app.taskForm('@Model.UserName', '@Model.Password', filter, '@Model.Company', totalQty, @Model.TaskItem.HWMS_ITASK);
            },
            failure: function (response) {
                console.log(response);
            },
            error: function (response) {
                console.log(response);
            },
            contentType: "application/json; charset=utf-8"
            //dataType: "json"
        });

        //window.app.AddLotRows(ctasks, $("#task_type").val());

    }
</script>

<style>
    .number-input input[type="number"] {
        -webkit-appearance: textfield;
        -moz-appearance: textfield;
    }

    .number-input input[type=number]::-webkit-inner-spin-button,
    .number-input input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
    }

    .number-input {
        margin-bottom: 0.5rem;
    }

        .number-input button {
            -webkit-appearance: none;
            background-color: #3DBFD9;
            border: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0;
            position: relative;
            color: white !important;
        }

            .number-input button:before,
            .number-input button:after {
                display: inline-block;
                position: absolute;
                content: '';
                height: 2px;
                transform: translate(-50%, -50%);
            }

            .number-input button.plus:after {
                transform: translate(-50%, -50%) rotate(90deg);
            }

        .number-input input[type=number] {
            text-align: center;
        }

        .number-input.number-input {
            border: 1px solid #ced4da;
            width: 10rem;
            border-radius: .25rem;
        }

            .number-input.number-input button {
                width: 2.6rem;
                height: .7rem;
            }

                .number-input.number-input button.minus {
                    padding-left: 10px;
                }

                .number-input.number-input button:before,
                .number-input.number-input button:after {
                    width: .7rem;
                    background-color: white;
                }

            .number-input.number-input input[type=number] {
                max-width: 4rem;
                padding: .5rem;
                border: 1px solid #ced4da;
                border-width: 0 1px;
                font-size: 1rem;
                height: 2rem;
                color: #495057;
            }

    @@media not all and (min-resolution:.001dpcm) {
        @@supports (-webkit-appearance: none) and (stroke-color:transparent) {

            .number-input.def-number-input.safari_only button:before,
            .number-input.def-number-input.safari_only button:after {
                margin-top: -.3rem;
            }
        }
    }
</style>

